name: Bicep Compile & Validations

on:
  workflow_dispatch:
  push:
    branches: [master, main, develop, 'feature/se-*']
  pull_request:
    branches: [master, main, develop]

jobs:
  validate-bicep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ "$BRANCH" == feature/se-* ]]; then
            ENV="dev"
          elif [[ "$BRANCH" == "develop" ]]; then
            ENV="uat"
          elif [[ "$BRANCH" == "master" || "$BRANCH" == "main" ]]; then
            ENV="prd"
          else
            ENV="dev"
          fi
          echo "env=$ENV" >> "$GITHUB_OUTPUT"
          echo "Environment: $ENV"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ 
            steps.env.outputs.env == 'dev' && secrets.AZURE_CREDENTIALS_DEV ||
            steps.env.outputs.env == 'uat' && secrets.AZURE_CREDENTIALS_UAT ||
            steps.env.outputs.env == 'sbx' && secrets.AZURE_CREDENTIALS_SBX ||
            secrets.AZURE_CREDENTIALS_PRD 
          }}

      - name: Lint & Build Bicep files
        run: |
          find infra/ -type f -name "*.bicep" | while read file; do
            echo "Processing: $file"
            az bicep lint --file "$file"
            az bicep build --file "$file"
          done
          echo "✅ All Bicep files validated"

      - name: Validate parameter files
        run: |
          ENV="${{ steps.env.outputs.env }}"
          find infra/ -type f -name "*-${ENV}.parameters.json" | while read file; do
            echo "Validating: $file"
            jq empty "$file" || exit 1
          done
          echo "✅ All parameter files are valid JSON"
